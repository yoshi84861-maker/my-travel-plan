<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¦åŠƒå¸« - ç·¨è¼¯åŠ å¼·ç‰ˆ âœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #suggestionBox { z-index: 100; max-height: 200px; overflow-y: auto; }
        .selected-bg { background-color: #dbeafe !important; border: 2px solid #2563eb !important; }
        .edit-mode-border { border: 2px solid #ef4444 !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 font-sans text-slate-900">

    <div class="max-w-md mx-auto bg-white rounded-[2rem] shadow-2xl p-6 mt-4 border border-slate-100">
        <h1 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2">ğŸ“ æˆ‘çš„è¡Œç¨‹æ¸…å–®</h1>

        <div id="inputForm" class="space-y-4 bg-slate-50 p-5 rounded-3xl mb-8 border border-slate-200">
            <div class="relative">
                <label class="block text-xs font-black text-slate-400 uppercase mb-1">ç›®çš„åœ°</label>
                <input id="cityInput" type="text" oninput="handleSearch()" placeholder="æœå°‹åŸå¸‚ä¸¦é»æ“Š..." 
                    class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400 transition">
                <div id="suggestionBox" class="absolute left-0 right-0 bg-white border rounded-xl mt-2 shadow-2xl hidden"></div>
                <div id="selectionStatus" class="text-xs mt-1 text-blue-600 font-bold px-1"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase mb-1">æ—¥æœŸ</label>
                    <input id="dateInput" type="date" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase mb-1">æ™‚é–“</label>
                    <input id="timeInput" type="time" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <div>
                <label class="block text-xs font-black text-slate-400 uppercase mb-1">è¡Œç¨‹è©³ç´°å…§å®¹</label>
                <textarea id="activityInput" placeholder="æƒ³å»å“ªè£¡ç©ï¼Ÿ" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm h-24 outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
            </div>

            <button id="addBtn" onclick="addOrUpdateTrip()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 active:scale-95 transition shadow-lg">
                æ·»åŠ è¡Œç¨‹
            </button>
            <button id="cancelEditBtn" onclick="resetForm()" class="w-full text-slate-400 py-2 text-sm hidden font-bold">å–æ¶ˆç·¨è¼¯</button>
        </div>

        <div id="tripList" class="space-y-4"></div>
        
        <div class="mt-10 pt-6 border-t border-slate-100 flex justify-between items-center">
            <button onclick="shareLink()" class="text-sm font-bold text-blue-500 hover:underline">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
            <button onclick="clearAll()" class="text-xs text-slate-300 hover:text-red-500">æ¸…é™¤æ‰€æœ‰è¡Œç¨‹</button>
        </div>
    </div>

    <script>
        const WEATHER_API_KEY = '2f6396d64af0f2086c95718c08352936';
        let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
        let selectedLocation = null;
        let editingTripId = null;

        let debounceTimer;
        async function handleSearch() {
            const query = document.getElementById('cityInput').value;
            const box = document.getElementById('suggestionBox');
            selectedLocation = null;
            clearTimeout(debounceTimer);
            if (query.length < 2) { box.classList.add('hidden'); return; }
            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    box.innerHTML = data.map(item => `<div onclick="selectLocation('${item.display_name.replace(/'/g, "\\'")}', ${item.lat}, ${item.lon})" class="p-4 hover:bg-blue-50 cursor-pointer border-b text-sm">ğŸ“ ${item.display_name}</div>`).join('');
                    box.classList.remove('hidden');
                } catch (e) { console.error("æœå°‹æœå‹™ç•°å¸¸"); }
            }, 500);
        }

        function selectLocation(name, lat, lon) {
            const shortName = name.split(',')[0];
            document.getElementById('cityInput').value = shortName;
            document.getElementById('cityInput').classList.add('selected-bg');
            document.getElementById('selectionStatus').innerText = "âœ… åœ°é»å·²é¸å–";
            document.getElementById('suggestionBox').classList.add('hidden');
            selectedLocation = { name: shortName, lat, lon };
        }

        async function addOrUpdateTrip() {
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const activity = document.getElementById('activityInput').value;

            if (!selectedLocation || !date || !time) return alert("è«‹å®Œæ•´å¡«å¯«åœ°é»ã€æ—¥æœŸèˆ‡æ™‚é–“ï¼");

            const btn = document.getElementById('addBtn');
            btn.innerText = "å„²å­˜ä¸­...";
            btn.disabled = true;

            // åªæœ‰åœ°é»æ”¹è®Šæ™‚æ‰é‡æ–°æŠ“å¤©æ°£ï¼Œç·¨è¼¯æ¨¡å¼è‹¥æ²’æ”¹åœ°é»å‰‡å»¶ç”¨èˆŠå¤©æ°£
            let weather = "ç„¡å¤©æ°£è³‡è¨Š";
            if (selectedLocation.lat !== 0) {
                weather = await fetchWeather(selectedLocation.lat, selectedLocation.lon);
            } else if (editingTripId) {
                const oldTrip = trips.find(t => t.id === editingTripId);
                weather = oldTrip.weather;
            }

            if (editingTripId) {
                const index = trips.findIndex(t => t.id === editingTripId);
                trips[index] = { ...trips[index], city: selectedLocation.name, date, time, activity, weather };
            } else {
                trips.push({ id: Date.now(), city: selectedLocation.name, date, time, activity, weather });
            }

            localStorage.setItem('myTrips', JSON.stringify(trips));
            render();
            resetForm();
            btn.disabled = false;
        }

        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
                const data = await res.json();
                return data.cod === 200 ? `${Math.round(data.main.temp)}Â°C ${data.weather[0].description}` : "ç„¡å¤©æ°£";
            } catch { return "å¤©æ°£é›¢ç·š"; }
        }

        function editTrip(id) {
            const trip = trips.find(t => t.id === id);
            if (!trip) return;

            editingTripId = id;
            document.getElementById('cityInput').value = trip.city;
            document.getElementById('dateInput').value = trip.date;
            document.getElementById('timeInput').value = trip.time;
            document.getElementById('activityInput').value = trip.activity;
            
            // æ¨™è¨˜ç‚ºç·¨è¼¯ç‹€æ…‹
            selectedLocation = { name: trip.city, lat: 0, lon: 0 }; 
            document.getElementById('inputForm').classList.add('edit-mode-border');
            document.getElementById('cityInput').classList.add('selected-bg');
            document.getElementById('addBtn').innerText = "å„²å­˜ä¿®æ”¹";
            document.getElementById('addBtn').classList.replace('bg-blue-600', 'bg-red-500');
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            editingTripId = null;
            document.getElementById('cityInput').value = "";
            document.getElementById('dateInput').value = "";
            document.getElementById('timeInput').value = "";
            document.getElementById('activityInput').value = "";
            document.getElementById('inputForm').classList.remove('edit-mode-border');
            document.getElementById('cityInput').classList.remove('selected-bg');
            document.getElementById('selectionStatus').innerText = "";
            document.getElementById('addBtn').innerText = "æ·»åŠ è¡Œç¨‹";
            document.getElementById('addBtn').classList.replace('bg-red-500', 'bg-blue-600');
            document.getElementById('cancelEditBtn').classList.add('hidden');
            selectedLocation = null;
        }

        function deleteTrip(id) {
            if (confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹å—ï¼Ÿ")) {
                trips = trips.filter(t => t.id !== id);
                localStorage.setItem('myTrips', JSON.stringify(trips));
                render();
            }
        }

        function render() {
            const list = document.getElementById('tripList');
            trips.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
            
            list.innerHTML = trips.map((t, index) => {
                let transitBtn = "";
                if (index < trips.length - 1) {
                    const nextTrip = trips[index + 1];
                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(t.city)}&destination=${encodeURIComponent(nextTrip.city)}&travelmode=transit`;
                    transitBtn = `
                        <div class="flex justify-center my-2">
                            <a href="${mapsUrl}" target="_blank" class="text-[10px] bg-slate-200 text-slate-500 px-3 py-1 rounded-full font-bold hover:bg-blue-100 transition">ğŸšŒ æŸ¥è©¢äº¤é€šæ™‚é–“</a>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white p-5 rounded-[1.5rem] border-2 border-slate-100 shadow-sm relative group">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[10px] font-black text-blue-500 uppercase">${t.date} Â· <span class="text-orange-500">${t.time}</span></span>
                                <h3 class="font-bold text-slate-800 text-lg">${t.city}</h3>
                            </div>
                            <div class="bg-blue-50 px-2 py-1 rounded-lg text-[10px] font-bold text-blue-600">${t.weather}</div>
                        </div>
                        <p class="text-slate-500 text-sm mt-2 border-t pt-2 border-dashed border-slate-100 whitespace-pre-line">${t.activity || 'ç„¡è©³ç´°è¡Œç¨‹'}</p>
                        <div class="flex gap-4 mt-3 justify-end border-t pt-2 border-slate-50">
                            <button onclick="editTrip(${t.id})" class="text-xs font-bold text-blue-400 hover:text-blue-600">âœï¸ ç·¨è¼¯è¡Œç¨‹</button>
                            <button onclick="deleteTrip(${t.id})" class="text-xs font-bold text-slate-300 hover:text-red-500">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                    ${transitBtn}
                `;
            }).join('');
        }

        function shareLink() {
            if (trips.length === 0) return alert("è«‹å…ˆåŠ å…¥è¡Œç¨‹ï¼");
            const dataStr = btoa(encodeURIComponent(JSON.stringify(trips)));
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${dataStr}`;
            navigator.clipboard.writeText(shareUrl).then(() => alert("åˆ†äº«é€£çµå·²è¤‡è£½ï¼"));
        }

        function clearAll() {
            if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¡Œç¨‹å—ï¼Ÿ")) {
                trips = [];
                localStorage.setItem('myTrips', JSON.stringify(trips));
                render();
            }
        }

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const sharedData = params.get('data');
            if (sharedData) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(sharedData)));
                    trips = decoded;
                    localStorage.setItem('myTrips', JSON.stringify(trips));
                } catch (e) {}
            }
            render();
        };
    </script>
</body>
</html>
