<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…éŠè¦åŠƒå¸« âœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .suggestion-item:last-child { border-bottom: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div class="max-w-md mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-slate-800">æˆ‘çš„æ—…ç¨‹è¨ˆç•«</h1>
            <p class="text-slate-500 text-sm">è¼¸å…¥åœ°é»èˆ‡æ—¥æœŸï¼Œè‡ªå‹•æŸ¥çœ‹é å ±</p>
        </header>

        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <div class="space-y-4">
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">ç›®çš„åœ°</label>
                    <input id="cityInput" type="text" oninput="handleSearch()" placeholder="æœå°‹åŸå¸‚ (ä¸­/è‹±)..." 
                           class="w-full p-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                    <div id="suggestionBox" class="absolute z-20 w-full mt-1 bg-white border rounded-xl shadow-xl hidden max-h-60 overflow-y-auto"></div>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">æ—¥æœŸ</label>
                        <input id="dateInput" type="date" class="w-full p-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">è¡Œç¨‹å…§å®¹</label>
                    <textarea id="activityInput" placeholder="æƒ³å»å“ªè£¡é€›é€›ï¼Ÿ" class="w-full p-3 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 h-24 transition"></textarea>
                </div>

                <button onclick="addTrip()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-blue-200 shadow-lg hover:bg-blue-700 active:scale-95 transition">
                    åŠ å…¥è¡Œç¨‹
                </button>
            </div>
        </div>

        <div id="tripList" class="space-y-4">
            </div>
    </div>

    <script>
        // --- è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ API KEY ---
        const WEATHER_API_KEY = 'åœ¨æ­¤è™•è²¼ä¸Šä½ çš„_API_KEY'; 
        
        let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
        let selectedLocation = null;

        // 1. åŸå¸‚æœå°‹è‡ªå‹•æ¯”å° (Nominatim å…è²» API)
        let debounceTimer;
        function handleSearch() {
            const query = document.getElementById('cityInput').value;
            const box = document.getElementById('suggestionBox');
            
            clearTimeout(debounceTimer);
            if (query.length < 2) { box.classList.add('hidden'); return; }

            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5&addressdetails=1`);
                    const data = await res.json();
                    
                    box.innerHTML = data.map(item => `
                        <div class="suggestion-item p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-100 text-sm text-slate-700"
                             onclick="selectLocation('${item.display_name}', ${item.lat}, ${item.lon})">
                            ğŸ“ ${item.display_name}
                        </div>
                    `).join('');
                    box.classList.remove('hidden');
                } catch (e) { console.error("æœå°‹å‡ºéŒ¯", e); }
            }, 500);
        }

        function selectLocation(name, lat, lon) {
            const shortName = name.split(',')[0];
            document.getElementById('cityInput').value = shortName;
            document.getElementById('suggestionBox').classList.add('hidden');
            selectedLocation = { name: shortName, lat, lon };
        }

        // 2. ç²å–å¤©æ°£è³‡æ–™
        async function fetchWeather(lat, lon) {
            if (!WEATHER_API_KEY || WEATHER_API_KEY === 'åœ¨æ­¤è™•è²¼ä¸Šä½ çš„_API_KEY') return "æœªè¨­å®š API Key";
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
                const data = await res.json();
                return `${Math.round(data.main.temp)}Â°C ${data.weather[0].description}`;
            } catch { return "å¤©æ°£è®€å–å¤±æ•—"; }
        }

        // 3. æ–°å¢è¡Œç¨‹
        async function addTrip() {
            const date = document.getElementById('dateInput').value;
            const activity = document.getElementById('activityInput').value;
            
            if (!selectedLocation || !date) return alert("è«‹å…ˆé¸æ“‡ç›®çš„åœ°ä¸¦è¼¸å…¥æ—¥æœŸ");

            const weatherInfo = await fetchWeather(selectedLocation.lat, selectedLocation.lon);
            
            const newTrip = {
                id: Date.now(),
                city: selectedLocation.name,
                date,
                activity,
                weather: weatherInfo
            };

            trips.push(newTrip);
            saveAndRender();
            
            // é‡ç½®è¼¸å…¥
            document.getElementById('cityInput').value = '';
            document.getElementById('activityInput').value = '';
            selectedLocation = null;
        }

        function deleteTrip(id) {
            trips = trips.filter(t => t.id !== id);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('myTrips', JSON.stringify(trips));
            render();
        }

        function render() {
            const list = document.getElementById('tripList');
            trips.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            list.innerHTML = trips.map(t => `
                <div class="bg-white rounded-2xl p-5 shadow-sm border border-slate-100 relative group transition hover:shadow-md">
                    <button onclick="deleteTrip(${t.id})" class="absolute top-4 right-4 text-slate-300 hover:text-red-500">âœ•</button>
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-md">${t.date}</span>
                            <h3 class="text-lg font-bold text-slate-800 mt-1">${t.city}</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">ç•¶å‰å¤©æ°£</p>
                            <p class="text-sm font-bold text-orange-500">${t.weather}</p>
                        </div>
                    </div>
                    <p class="text-slate-600 text-sm leading-relaxed whitespace-pre-line border-t pt-3">${t.activity || 'å°šç„¡å‚™è¨»è¡Œç¨‹'}</p>
                </div>
            `).join('');
        }

        // é»æ“Šç©ºç™½è™•é—œé–‰é¸å–®
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#cityInput')) {
                document.getElementById('suggestionBox').classList.add('hidden');
            }
        });

        render();
    </script>
</body>
</html>
