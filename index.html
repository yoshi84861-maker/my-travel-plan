<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…éŠæ—¥èªŒ âœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .day-page { position: relative; background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; overflow: hidden; }
        .day-header { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 1.5rem; }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-md mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800">æ—…éŠè¡Œç¨‹è¡¨</h1>
            <p class="text-slate-500">è¦åŠƒæ¯ä¸€å¤©çš„ç²¾å½©å†’éšª</p>
        </header>

        <div class="bg-white rounded-2xl shadow-md p-6 mb-10 border border-slate-100">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">æ—¥æœŸ</label>
                        <input id="dateInput" type="date" class="w-full p-2 bg-slate-50 rounded-lg outline-none border focus:border-blue-500 transition">
                    </div>
                    <div class="relative">
                        <label class="block text-xs font-bold text-slate-400 mb-1">ç›®çš„åœ° (å¤©æ°£ä¾†æº)</label>
                        <input id="cityInput" type="text" oninput="handleSearch()" placeholder="æœå°‹..." 
                               class="w-full p-2 bg-slate-50 rounded-lg outline-none border focus:border-blue-500 transition">
                        <div id="suggestionBox" class="absolute z-30 w-full mt-1 bg-white border rounded-lg shadow-xl hidden max-h-48 overflow-y-auto text-sm"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">æ´»å‹•å…§å®¹</label>
                    <input id="activityInput" type="text" placeholder="ä¾‹å¦‚ï¼šå»åƒæ‹‰éºµã€åƒè§€åšç‰©é¤¨..." 
                           class="w-full p-3 bg-slate-50 rounded-lg outline-none border focus:border-blue-500 transition">
                </div>
                <button onclick="addTrip()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition active:scale-95">
                    æ–°å¢è‡³è¡Œç¨‹
                </button>
            </div>
        </div>

        <div id="tripContainer">
            </div>
    </div>

    <script>
        const WEATHER_API_KEY = 'åœ¨æ­¤è™•è²¼ä¸Šä½ çš„_API_KEY'; 
        
        let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
        let selectedLocation = null;

        // åŸå¸‚æœå°‹
        let debounceTimer;
        function handleSearch() {
            const query = document.getElementById('cityInput').value;
            const box = document.getElementById('suggestionBox');
            clearTimeout(debounceTimer);
            if (query.length < 2) { box.classList.add('hidden'); return; }
            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=5`);
                    const data = await res.json();
                    box.innerHTML = data.map(item => `
                        <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-50"
                             onclick="selectLocation('${item.display_name.split(',')[0]}', ${item.lat}, ${item.lon})">
                            ğŸ“ ${item.display_name.split(',')[0]} <span class="text-xs text-gray-400">${item.display_name.split(',').slice(1,3)}</span>
                        </div>
                    `).join('');
                    box.classList.remove('hidden');
                } catch (e) { console.error(e); }
            }, 500);
        }

        function selectLocation(name, lat, lon) {
            document.getElementById('cityInput').value = name;
            document.getElementById('suggestionBox').classList.add('hidden');
            selectedLocation = { name, lat, lon };
        }

        // ç²å–å¤©æ°£
        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
                const data = await res.json();
                if(data.cod !== 200) return "æš«ç„¡å¤©æ°£";
                return `${Math.round(data.main.temp)}Â°C | ${data.weather[0].description}`;
            } catch { return "è®€å–å¤±æ•—"; }
        }

        // æ–°å¢è¡Œç¨‹
        async function addTrip() {
            const date = document.getElementById('dateInput').value;
            const activity = document.getElementById('activityInput').value;
            if (!date || !activity) return alert("è«‹è¼¸å…¥æ—¥æœŸèˆ‡æ´»å‹•å…§å®¹");

            // å¦‚æœè©²æ—¥æœŸé‚„æ²’æœ‰ç›®çš„åœ°è³‡è¨Šï¼Œå‰‡è¨˜éŒ„ç›®å‰çš„é¸æ“‡
            const existingDay = trips.find(t => t.date === date);
            
            const newEntry = {
                id: Date.now(),
                date,
                activity,
                city: selectedLocation ? selectedLocation.name : (existingDay ? existingDay.city : "æœªçŸ¥åœ°é»"),
                lat: selectedLocation ? selectedLocation.lat : (existingDay ? existingDay.lat : null),
                lon: selectedLocation ? selectedLocation.lon : (existingDay ? existingDay.lon : null)
            };

            // å¦‚æœè©²æ—¥æœŸçš„å¤©æ°£é‚„æ²’æŠ“éï¼Œä¸”ç¾åœ¨æœ‰ç¶“ç·¯åº¦ï¼Œå°±å»æŠ“
            if (newEntry.lat && !newEntry.weather) {
                newEntry.weather = await fetchWeather(newEntry.lat, newEntry.lon);
            }

            trips.push(newEntry);
            saveAndRender();
            document.getElementById('activityInput').value = '';
        }

        function deleteEntry(id) {
            trips = trips.filter(t => t.id !== id);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('myTrips', JSON.stringify(trips));
            render();
        }

        function render() {
            const container = document.getElementById('tripContainer');
            if (trips.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 mt-10">å°šç„¡è¡Œç¨‹ï¼Œé–‹å§‹è¦åŠƒå§ï¼</p>';
                return;
            }

            // 1. å…ˆæŒ‰æ—¥æœŸåˆ†çµ„
            const grouped = trips.reduce((acc, trip) => {
                if (!acc[trip.date]) acc[trip.date] = [];
                acc[trip.date].push(trip);
                return acc;
            }, {});

            // 2. æ’åºæ—¥æœŸ
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(a) - new Date(b));

            // 3. æ¸²æŸ“ HTML
            container.innerHTML = sortedDates.map(date => {
                const dayTrips = grouped[date];
                const mainInfo = dayTrips.find(t => t.weather) || dayTrips[0];
                
                return `
                    <div class="day-page">
                        <div class="day-header flex justify-between items-center">
                            <div>
                                <div class="text-xs opacity-80 font-bold uppercase">${date}</div>
                                <div class="text-xl font-bold">${mainInfo.city}</div>
                            </div>
                            <div class="text-right text-white">
                                <div class="text-xs opacity-80">ä»Šæ—¥é å ±</div>
                                <div class="font-bold">${mainInfo.weather || 'å°šæœªæ›´æ–°'}</div>
                            </div>
                        </div>
                        <div class="p-4 space-y-3">
                            ${dayTrips.map(item => `
                                <div class="flex justify-between items-center group p-2 hover:bg-slate-50 rounded-lg transition">
                                    <div class="flex items-center gap-3">
                                        <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                                        <span class="text-slate-700">${item.activity}</span>
                                    </div>
                                    <button onclick="deleteEntry(${item.id})" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">âœ•</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        render();
    </script>
</body>
</html>
