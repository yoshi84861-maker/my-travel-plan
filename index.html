<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠè¦åŠƒå¸« - äº¤é€šåŠ å¼·ç‰ˆ âœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #suggestionBox { z-index: 100; max-height: 200px; overflow-y: auto; }
        .selected-bg { background-color: #dbeafe !important; border: 2px solid #2563eb !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 font-sans text-slate-900">

    <div class="max-w-md mx-auto bg-white rounded-[2rem] shadow-2xl p-6 mt-4 border border-slate-100">
        <h1 class="text-2xl font-black text-slate-800 mb-6 flex items-center gap-2">ğŸ“ è©³ç´°è¡Œç¨‹è¡¨</h1>

        <div class="space-y-4 bg-slate-50 p-5 rounded-3xl mb-8 border border-slate-200">
            <div class="relative">
                <label class="block text-xs font-black text-slate-400 uppercase mb-1">ç›®çš„åœ°</label>
                <input id="cityInput" type="text" oninput="handleSearch()" placeholder="æœå°‹åŸå¸‚..." 
                    class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
                <div id="suggestionBox" class="absolute left-0 right-0 bg-white border rounded-xl mt-2 shadow-2xl hidden"></div>
                <div id="selectionStatus" class="text-xs mt-1 text-blue-600 font-bold px-1"></div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase mb-1">æ—¥æœŸ</label>
                    <input id="dateInput" type="date" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-400 uppercase mb-1">æ™‚é–“</label>
                    <input id="timeInput" type="time" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
                </div>
            </div>

            <div>
                <label class="block text-xs font-black text-slate-400 uppercase mb-1">äº¤é€šå‚™è¨» (å¦‚: éœ€æ­ç«è»Š30åˆ†)</label>
                <input id="transitInput" type="text" placeholder="å¤§çœ¾é‹è¼¸è³‡è¨Š..." class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
            </div>

            <div>
                <label class="block text-xs font-black text-slate-400 uppercase mb-1">è¡Œç¨‹å…§å®¹</label>
                <textarea id="activityInput" placeholder="è©³ç´°è¨ˆç•«..." class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm h-16 outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
            </div>

            <button id="addBtn" onclick="addOrUpdateTrip()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition">
                å„²å­˜è¡Œç¨‹
            </button>
        </div>

        <div id="tripList" class="space-y-4"></div>
    </div>

    <script>
        const WEATHER_API_KEY = '2f6396d64af0f2086c95718c08352936';
        let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
        let selectedLocation = null;
        let editingTripId = null;

        // æœå°‹é‚è¼¯ (Nominatim)
        let debounceTimer;
        async function handleSearch() {
            const query = document.getElementById('cityInput').value;
            const box = document.getElementById('suggestionBox');
            selectedLocation = null;
            clearTimeout(debounceTimer);
            if (query.length < 2) { box.classList.add('hidden'); return; }
            debounceTimer = setTimeout(async () => {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                const data = await res.json();
                box.innerHTML = data.map(item => `<div onclick="selectLocation('${item.display_name.replace(/'/g, "\\'")}', ${item.lat}, ${item.lon})" class="p-4 hover:bg-blue-50 cursor-pointer border-b text-sm">ğŸ“ ${item.display_name}</div>`).join('');
                box.classList.remove('hidden');
            }, 500);
        }

        function selectLocation(name, lat, lon) {
            const shortName = name.split(',')[0];
            document.getElementById('cityInput').value = shortName;
            document.getElementById('cityInput').classList.add('selected-bg');
            document.getElementById('suggestionBox').classList.add('hidden');
            selectedLocation = { name: shortName, lat, lon };
        }

        async function addOrUpdateTrip() {
            const date = document.getElementById('dateInput').value;
            const time = document.getElementById('timeInput').value;
            const transit = document.getElementById('transitInput').value;
            const activity = document.getElementById('activityInput').value;

            if (!selectedLocation || !date || !time) return alert("è«‹å¡«å¯«åœ°é»ã€æ—¥æœŸèˆ‡æ™‚é–“ï¼");

            const weather = await fetchWeather(selectedLocation.lat, selectedLocation.lon);

            if (editingTripId) {
                const index = trips.findIndex(t => t.id === editingTripId);
                trips[index] = { ...trips[index], city: selectedLocation.name, date, time, transit, activity, weather };
                editingTripId = null;
            } else {
                trips.push({ id: Date.now(), city: selectedLocation.name, date, time, transit, activity, weather });
            }
            saveAndRender();
            location.reload(); // é‡ç½®ç•«é¢
        }

        async function fetchWeather(lat, lon) {
            const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
            const data = await res.json();
            return data.cod === 200 ? `${Math.round(data.main.temp)}Â°C ${data.weather[0].description}` : "ç„¡å¤©æ°£";
        }

        function render() {
            const list = document.getElementById('tripList');
            trips.sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
            
            list.innerHTML = trips.map((t, index) => {
                // ç”¢ç”Ÿ Google Maps å°èˆªé€£çµ (åˆ°ä¸‹ä¸€å€‹åœ°é»)
                let transitBtn = "";
                if (index < trips.length - 1) {
                    const nextTrip = trips[index + 1];
                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(t.city)}&destination=${encodeURIComponent(nextTrip.city)}&travelmode=transit`;
                    transitBtn = `
                        <div class="flex justify-center my-2">
                            <a href="${mapsUrl}" target="_blank" class="text-[10px] bg-slate-200 text-slate-600 px-3 py-1 rounded-full hover:bg-blue-100 hover:text-blue-600 transition font-bold">
                                ğŸšŒ æŸ¥è©¢å‰å¾€ä¸‹å€‹é»çš„äº¤é€š
                            </a>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white p-5 rounded-[1.5rem] border-2 border-slate-100 shadow-sm relative">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="text-[10px] font-black text-blue-500 uppercase">${t.date} Â· <span class="text-orange-500">${t.time}</span></span>
                                <h3 class="font-bold text-slate-800 text-lg">${t.city}</h3>
                            </div>
                            <div class="bg-blue-50 px-2 py-1 rounded-lg text-[10px] font-bold text-blue-600">${t.weather}</div>
                        </div>
                        ${t.transit ? `<p class="text-[11px] text-blue-400 font-bold mb-1">ğŸš‡ ${t.transit}</p>` : ''}
                        <p class="text-slate-500 text-sm border-t pt-2 mt-2 border-dashed border-slate-100">${t.activity || 'ç„¡è©³ç´°è¡Œç¨‹'}</p>
                        <div class="flex gap-2 mt-3 justify-end">
                            <button onclick="editTrip(${t.id})" class="text-xs text-slate-300 italic">Edit</button>
                        </div>
                    </div>
                    ${transitBtn}
                `;
            }).join('');
        }

        function saveAndRender() { localStorage.setItem('myTrips', JSON.stringify(trips)); render(); }
        render();
    </script>
</body>
</html>
