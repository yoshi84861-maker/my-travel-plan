<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…éŠè¦åŠƒå¸« âœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* é¿å…è‡ªå‹•è£œå…¨é¸å–®è¢«é®æ“‹ */
        #suggestionBox { z-index: 50; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4">

    <div class="max-w-md mx-auto bg-white rounded-3xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">ğŸ“ æ—…éŠè¡Œç¨‹è¦åŠƒ</h1>

        <div class="space-y-4 mb-8">
            <div class="relative">
                <label class="block text-sm font-medium text-gray-700 mb-1">ä½ æƒ³å»å“ªè£¡ï¼Ÿ</label>
                <input id="cityInput" type="text" oninput="handleSearch()" placeholder="è¼¸å…¥åŸå¸‚åç¨± (ä¾‹å¦‚: æ±äº¬)" 
                    class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                <div id="suggestionBox" class="absolute left-0 right-0 bg-white border rounded-xl mt-1 shadow-xl hidden"></div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºç™¼æ—¥æœŸ</label>
                <input id="dateInput" type="date" class="w-full p-3 border rounded-xl outline-none">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">è¡Œç¨‹å…§å®¹</label>
                <textarea id="activityInput" placeholder="é€™å¤©è¦åšä»€éº¼å‘¢ï¼Ÿ" class="w-full p-3 border rounded-xl h-24 outline-none"></textarea>
            </div>

            <button onclick="addTrip()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg">
                â• åŠ å…¥æˆ‘çš„æ¸…å–®
            </button>
        </div>

        <div id="tripList" class="space-y-4"></div>

        <div class="mt-8 border-t pt-4 flex justify-between text-xs text-gray-400">
            <button onclick="shareLink()" class="text-blue-500 hover:underline">ğŸ”— è¤‡è£½åˆ†äº«é€£çµ</button>
            <button onclick="clearAll()" class="hover:text-red-500">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¡Œç¨‹</button>
        </div>
    </div>

    <script>
        const WEATHER_API_KEY = '2f6396d64af0f2086c95718c08352936';
        let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
        let selectedLocation = null;

        // 1. åŸå¸‚æœå°‹è‡ªå‹•æ¯”å°
        let debounceTimer;
        async function handleSearch() {
            const query = document.getElementById('cityInput').value;
            const box = document.getElementById('suggestionBox');
            clearTimeout(debounceTimer);
            if (query.length < 2) { box.classList.add('hidden'); return; }

            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    if (data.length === 0) {
                        box.innerHTML = `<div class="p-3 text-gray-400">æ‰¾ä¸åˆ°é€™å€‹åœ°æ–¹</div>`;
                    } else {
                        box.innerHTML = data.map(item => `
                            <div onclick="selectLocation('${item.display_name}', ${item.lat}, ${item.lon})" 
                                class="p-3 hover:bg-blue-50 cursor-pointer border-b last:border-0 text-sm">
                                ğŸ“ ${item.display_name}
                            </div>
                        `).join('');
                    }
                    box.classList.remove('hidden');
                } catch (e) {
                    box.classList.add('hidden');
                }
            }, 500);
        }

        function selectLocation(name, lat, lon) {
            const shortName = name.split(',')[0];
            document.getElementById('cityInput').value = shortName;
            document.getElementById('suggestionBox').classList.add('hidden');
            selectedLocation = { name: shortName, lat, lon };
        }

        // 2. ç²å–å¤©æ°£è³‡æ–™
        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
                const data = await res.json();
                if (data.cod !== 200) return "ç„¡æ³•ç²å–å¤©æ°£";
                return `${Math.round(data.main.temp)}Â°C ${data.weather[0].description}`;
            } catch {
                return "å¤©æ°£æœå‹™é›¢ç·š";
            }
        }

        // 3. æ–°å¢è¡Œç¨‹
        async function addTrip() {
            const date = document.getElementById('dateInput').value;
            const activity = document.getElementById('activityInput').value;

            if (!selectedLocation || !date) return alert("è«‹é¸æ“‡åœ°é»èˆ‡æ—¥æœŸï¼");

            const weather = await fetchWeather(selectedLocation.lat, selectedLocation.lon);
            const newTrip = { id: Date.now(), city: selectedLocation.name, date, activity, weather };
            
            trips.push(newTrip);
            saveAndRender();
            
            // é‡ç½®è¼¸å…¥
            document.getElementById('cityInput').value = '';
            document.getElementById('activityInput').value = '';
            selectedLocation = null;
        }

        function saveAndRender() {
            localStorage.setItem('myTrips', JSON.stringify(trips));
            render();
        }

        function render() {
            const list = document.getElementById('tripList');
            trips.sort((a, b) => new Date(a.date) - new Date(b.date));
            list.innerHTML = trips.map(t => `
                <div class="bg-blue-50 rounded-2xl p-4 border border-blue-100">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="text-xs font-bold text-blue-400">${t.date}</p>
                            <h3 class="font-bold text-gray-800">${t.city}</h3>
                        </div>
                        <span class="text-sm bg-white px-2 py-1 rounded-lg shadow-sm text-blue-600 font-medium">â˜€ï¸ ${t.weather}</span>
                    </div>
                    <p class="text-gray-600 text-sm">${t.activity}</p>
                </div>
            `).join('');
        }

        function shareLink() {
            const dataStr = btoa(encodeURIComponent(JSON.stringify(trips)));
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${dataStr}`;
            navigator.clipboard.writeText(shareUrl).then(() => alert("åˆ†äº«é€£çµå·²è¤‡è£½ï¼"));
        }

        function clearAll() {
            if (confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿ")) {
                trips = [];
                saveAndRender();
            }
        }

        // æª¢æŸ¥åˆ†äº«
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const sharedData = params.get('data');
            if (sharedData) {
                try {
                    trips = JSON.parse(decodeURIComponent(atob(sharedData)));
                    saveAndRender();
                } catch (e) {}
            } else {
                render();
            }
        };
    </script>
</body>
</html>
