<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…éŠè¦åŠƒå¸« âœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ç¢ºä¿ä¸‹æ‹‰é¸å–®åœ¨æœ€ä¸Šå±¤ */
        #suggestionBox { z-index: 100; max-height: 250px; overflow-y: auto; }
        .trip-card:hover .delete-btn { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 font-sans text-slate-900">

    <div class="max-w-md mx-auto bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100 mt-4">
        <div class="p-8">
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2 flex items-center gap-2">
                æ—…è¡Œè¨ˆç•« <span class="text-blue-500 text-2xl">ğŸŒ</span>
            </h1>
            <p class="text-slate-400 text-sm mb-8">è¦åŠƒä½ çš„ä¸‹ä¸€è¶Ÿå†’éšªï¼Œä¸¦æŸ¥çœ‹å¤©æ°£é å ±ã€‚</p>

            <div class="space-y-5 bg-slate-50 p-5 rounded-3xl mb-8">
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 ml-1">ç›®çš„åœ°</label>
                    <input id="cityInput" type="text" oninput="handleSearch()" placeholder="ä¾‹å¦‚ï¼šæ±äº¬, å°åŒ—..." 
                        class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400 transition">
                    <div id="suggestionBox" class="absolute left-0 right-0 bg-white border rounded-2xl mt-2 shadow-2xl hidden"></div>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 ml-1">æ—¥æœŸ</label>
                        <input id="dateInput" type="date" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 ml-1">è¡Œç¨‹å…§å®¹</label>
                    <textarea id="activityInput" placeholder="é€™å¤©æƒ³å»å“ªè£¡ç©ï¼Ÿ" class="w-full p-4 bg-white border-0 rounded-2xl shadow-sm h-24 outline-none focus:ring-2 focus:ring-blue-400 resize-none"></textarea>
                </div>

                <button onclick="addTrip()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-blue-700 active:scale-95 transition-all shadow-lg shadow-blue-200">
                    æ·»åŠ è¡Œç¨‹
                </button>
            </div>

            <div id="tripList" class="space-y-4">
                </div>

            <div class="mt-10 pt-6 border-t border-slate-100 flex justify-between items-center text-sm font-medium">
                <button onclick="shareLink()" class="flex items-center gap-1 text-blue-600 hover:text-blue-700">
                    ğŸ”— è¤‡è£½åˆ†äº«é€£çµ
                </button>
                <button onclick="clearAll()" class="text-slate-400 hover:text-red-500">
                    æ¸…ç©ºè¡Œç¨‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // ä½ çš„å°ˆå±¬ API KEY å·²ç½®å…¥
        const WEATHER_API_KEY = '2f6396d64af0f2086c95718c08352936';
        let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
        let selectedLocation = null;

        // 1. åŸå¸‚æœå°‹èˆ‡å»ºè­°åŠŸèƒ½
        let debounceTimer;
        async function handleSearch() {
            const query = document.getElementById('cityInput').value;
            const box = document.getElementById('suggestionBox');
            clearTimeout(debounceTimer);
            
            if (query.length < 2) {
                box.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`);
                    const data = await res.json();
                    
                    if (data.length === 0) {
                        box.innerHTML = `<div class="p-4 text-slate-400 text-sm">æ‰¾ä¸åˆ°ç›¸é—œåœ°é»</div>`;
                    } else {
                        box.innerHTML = data.map(item => {
                            const displayName = item.display_name;
                            return `
                                <div onclick="selectLocation('${displayName}', ${item.lat}, ${item.lon})" 
                                    class="p-4 hover:bg-blue-50 cursor-pointer border-b border-slate-50 last:border-0 text-sm text-slate-600 transition">
                                    ğŸ“ ${displayName}
                                </div>
                            `;
                        }).join('');
                    }
                    box.classList.remove('hidden');
                } catch (e) {
                    console.error("æœå°‹éŒ¯èª¤:", e);
                }
            }, 500);
        }

        function selectLocation(name, lat, lon) {
            const shortName = name.split(',')[0]; // å–è¼ƒçŸ­çš„åœ°å
            document.getElementById('cityInput').value = shortName;
            document.getElementById('suggestionBox').classList.add('hidden');
            selectedLocation = { name: shortName, lat, lon };
        }

        // 2. æŠ“å–å¤©æ°£è³‡æ–™
        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
                const data = await res.json();
                if (data.cod !== 200) return "æš«ç„¡å¤©æ°£";
                const temp = Math.round(data.main.temp);
                const desc = data.weather[0].description;
                return `${temp}Â°C ${desc}`;
            } catch (err) {
                return "é€£ç·šå¤±æ•—";
            }
        }

        // 3. æ–°å¢èˆ‡æ¸²æŸ“
        async function addTrip() {
            const date = document.getElementById('dateInput').value;
            const activity = document.getElementById('activityInput').value;

            if (!selectedLocation) return alert("è«‹å¾æœå°‹å»ºè­°ä¸­é¸æ“‡ä¸€å€‹åœ°é»å–”ï¼");
            if (!date) return alert("è«‹é¸æ“‡æ—¥æœŸï¼");

            const weather = await fetchWeather(selectedLocation.lat, selectedLocation.lon);
            const newTrip = {
                id: Date.now(),
                city: selectedLocation.name,
                date: date,
                activity: activity,
                weather: weather
            };

            trips.push(newTrip);
            saveAndRender();
            
            // é‡ç½®
            document.getElementById('cityInput').value = '';
            document.getElementById('activityInput').value = '';
            selectedLocation = null;
        }

        function deleteTrip(id) {
            trips = trips.filter(t => t.id !== id);
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('myTrips', JSON.stringify(trips));
            render();
        }

        function render() {
            const list = document.getElementById('tripList');
            trips.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (trips.length === 0) {
                list.innerHTML = `<p class="text-center text-slate-300 py-10">ç›®å‰é‚„æ²’æœ‰è¡Œç¨‹è¨ˆç•«...</p>`;
                return;
            }

            list.innerHTML = trips.map(t => `
                <div class="trip-card bg-slate-50 p-5 rounded-3xl border border-transparent hover:border-blue-200 transition relative group">
                    <button onclick="deleteTrip(${t.id})" class="delete-btn opacity-0 absolute -top-2 -right-2 bg-white text-slate-400 hover:text-red-500 shadow-md w-8 h-8 rounded-full transition-all">âœ•</button>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-[10px] font-black text-blue-500 uppercase tracking-tighter">${t.date}</span>
                            <h3 class="font-bold text-slate-800 text-lg">${t.city}</h3>
                        </div>
                        <div class="bg-white px-3 py-1 rounded-full shadow-sm">
                            <span class="text-xs font-bold text-slate-700">${t.weather}</span>
                        </div>
                    </div>
                    <p class="text-slate-500 text-sm leading-relaxed">${t.activity || 'æ²’æœ‰å‚™è¨»äº‹é …'}</p>
                </div>
            `).join('');
        }

        // 4. åˆ†äº«åŠŸèƒ½
        function shareLink() {
            if (trips.length === 0) return alert("å…ˆåŠ é»è¡Œç¨‹å†åˆ†äº«çµ¦æœ‹å‹å§ï¼");
            const dataStr = btoa(encodeURIComponent(JSON.stringify(trips)));
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${dataStr}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("âœ¨ åˆ†äº«é€£çµå·²è¤‡è£½ï¼å‚³çµ¦æœ‹å‹æ‰“é–‹å°±èƒ½çœ‹åˆ°ä½ çš„è¨ˆç•«ã€‚");
            });
        }

        function clearAll() {
            if (confirm("è¦æ¸…ç©ºæ‰€æœ‰å·²å„²å­˜çš„è¡Œç¨‹å—ï¼Ÿ")) {
                trips = [];
                saveAndRender();
            }
        }

        // é é¢å•Ÿå‹•è¼‰å…¥
        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const sharedData = params.get('data');
            if (sharedData) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(atob(sharedData)));
                    if (confirm("ç™¼ç¾å¥½å‹åˆ†äº«çš„æ—…éŠè¨ˆç•«ï¼Œè¦è¼‰å…¥å—ï¼Ÿ")) {
                        trips = decoded;
                        saveAndRender();
                        // æ¸…é™¤ç¶²å€åƒæ•¸ï¼Œé¿å…åˆ·æ–°å¾Œé‡è¤‡è©¢å•
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) { console.error("è§£æéŒ¯èª¤"); }
            }
            render();
        };
    </script>
</body>
</html>
