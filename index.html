<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—…éŠæ—¥èªŒ âœˆï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        .day-card { background: white; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 2rem; overflow: hidden; border: 1px solid #e2e8f0; }
        .day-header { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 1.25rem; }
        .time-badge { background: #eff6ff; color: #1e40af; font-weight: bold; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; border: 1px solid #dbeafe; min-width: 55px; text-align: center; }
    </style>
</head>
<body class="pb-20">

    <div class="max-w-md mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-slate-800 tracking-tight">æ—…ç¨‹è¨ˆç•«è¡¨ âœˆï¸</h1>
            <p class="text-slate-500 text-sm mt-1">åŒä¸€å¤©è¡Œç¨‹æœƒè‡ªå‹•åˆä½µ</p>
        </header>

        <div class="bg-white rounded-2xl shadow-sm p-6 mb-10 border border-slate-200">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">æ—¥æœŸ</label>
                        <input id="dateInput" type="date" class="w-full p-2 bg-slate-50 rounded-lg border outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">æ™‚é–“</label>
                        <input id="timeInput" type="time" class="w-full p-2 bg-slate-50 rounded-lg border outline-none focus:border-blue-500">
                    </div>
                </div>
                
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-400 mb-1">ç›®çš„åœ°</label>
                    <input id="cityInput" type="text" oninput="handleSearch()" placeholder="è¼¸å…¥åŸå¸‚ä¸¦å¾é¸å–®é»é¸" 
                           class="w-full p-2 bg-slate-50 rounded-lg border outline-none focus:border-blue-500">
                    <div id="suggestionBox" class="absolute z-30 w-full mt-1 bg-white border rounded-lg shadow-xl hidden max-h-48 overflow-y-auto text-sm"></div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1">è¡Œç¨‹å…§å®¹</label>
                    <input id="activityInput" type="text" placeholder="è¦åšä»€éº¼å‘¢ï¼Ÿ" 
                           class="w-full p-3 bg-slate-50 rounded-lg border outline-none focus:border-blue-500">
                </div>

                <button onclick="addTrip()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg">
                    åŠ å…¥è¡Œç¨‹è¡¨
                </button>
            </div>
        </div>

        <div id="tripContainer"></div>
    </div>

    <script>
        // --- è«‹ç¢ºèªé€™è£¡è²¼ä¸Šäº†ä½ çš„ API KEY ---
        const WEATHER_API_KEY = 'åœ¨æ­¤è™•è²¼ä¸Šä½ çš„_API_KEY'; 
        
        let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
        let selectedLocation = null;

        let debounceTimer;
        function handleSearch() {
            const query = document.getElementById('cityInput').value;
            const box = document.getElementById('suggestionBox');
            clearTimeout(debounceTimer);
            if (query.length < 2) { box.classList.add('hidden'); return; }
            debounceTimer = setTimeout(async () => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                    const data = await res.json();
                    box.innerHTML = data.map(item => {
                        const name = item.display_name.split(',')[0].replace(/'/g, "\\'");
                        return `<div class="p-3 hover:bg-blue-50 cursor-pointer border-b" onclick="selectLocation('${name}', ${item.lat}, ${item.lon})">ğŸ“ ${item.display_name}</div>`;
                    }).join('');
                    box.classList.remove('hidden');
                } catch (e) { console.log(e); }
            }, 500);
        }

        function selectLocation(name, lat, lon) {
            document.getElementById('cityInput').value = name;
            document.getElementById('suggestionBox').classList.add('hidden');
            selectedLocation = { name, lat, lon };
        }

        async function addTrip() {
            const dateInput = document.getElementById('dateInput');
            const timeInput = document.getElementById('timeInput');
            const cityInput = document.getElementById('cityInput');
            const activityInput = document.getElementById('activityInput');

            if (!dateInput.value || !activityInput.value) {
                alert("è«‹è‡³å°‘å¡«å¯«æ—¥æœŸèˆ‡è¡Œç¨‹å…§å®¹ï¼");
                return;
            }

            let weatherInfo = "";
            let cityToSave = selectedLocation ? selectedLocation.name : (cityInput.value || "æœªè¨­å®šåœ°é»");

            // æŠ“å–å¤©æ°£
            if (selectedLocation) {
                try {
                    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${selectedLocation.lat}&lon=${selectedLocation.lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
                    const data = await res.json();
                    if (data.cod === 200) {
                        weatherInfo = `${Math.round(data.main.temp)}Â°C ${data.weather[0].description}`;
                    }
                } catch (e) { weatherInfo = "å¤©æ°£è®€å–å¤±æ•—"; }
            }

            const newEntry = {
                id: Date.now(),
                date: dateInput.value,
                time: timeInput.value || "00:00",
                activity: activityInput.value,
                city: cityToSave,
                weather: weatherInfo
            };

            trips.push(newEntry);
            localStorage.setItem('myTrips', JSON.stringify(trips));
            
            // é‡ç½®è¼¸å…¥
            activityInput.value = '';
            timeInput.value = '';
            selectedLocation = null;
            render();
        }

        function deleteEntry(id) {
            trips = trips.filter(t => t.id !== id);
            localStorage.setItem('myTrips', JSON.stringify(trips));
            render();
        }

        function render() {
            const container = document.getElementById('tripContainer');
            if (trips.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-400 mt-10">å°šç„¡è¡Œç¨‹</p>';
                return;
            }

            const groups = {};
            trips.forEach(t => {
                if (!groups[t.date]) groups[t.date] = [];
                groups[t.date].push(t);
            });

            const sortedDates = Object.keys(groups).sort((a, b) => new Date(a) - new Date(b));

            container.innerHTML = sortedDates.map(date => {
                const dayItems = groups[date];
                dayItems.sort((a, b) => a.time.localeCompare(b.time));
                
                const hasWeather = dayItems.find(i => i.weather !== "");
                const displayCity = hasWeather ? hasWeather.city : dayItems[0].city;
                const displayWeather = hasWeather ? hasWeather.weather : "ç„¡å¤©æ°£è³‡è¨Š";

                return `
                    <div class="day-card">
                        <div class="day-header flex justify-between items-center">
                            <div>
                                <div class="text-[10px] font-bold opacity-70 mb-1 uppercase">${date}</div>
                                <div class="text-xl font-bold italic">${displayCity}</div>
                            </div>
                            <div class="bg-white/20 px-3 py-1 rounded-full text-sm font-bold">${displayWeather}</div>
                        </div>
                        <div class="p-2">
                            ${dayItems.map(item => `
                                <div class="flex items-center gap-4 p-3 hover:bg-slate-50 rounded-xl group border-b border-slate-50 last:border-none">
                                    <div class="time-badge">${item.time}</div>
                                    <div class="flex-1 text-slate-700 font-medium">${item.activity}</div>
                                    <button onclick="deleteEntry(${item.id})" class="text-slate-300 hover:text-red-500">âœ•</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }).join('');
        }

        render();
    </script>
</body>
</html>
