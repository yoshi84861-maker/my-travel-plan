// --- è«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ API KEY ---
const WEATHER_API_KEY = 'åœ¨æ­¤è™•è²¼ä¸Šä½ çš„_API_KEY'; 

let trips = JSON.parse(localStorage.getItem('myTrips')) || [];
let selectedLocation = null;

// 1. åŸå¸‚æœå°‹è‡ªå‹•æ¯”å° (åŠ å…¥éŒ¯èª¤å›å ±)
let debounceTimer;
async function handleSearch() {
    const query = document.getElementById('cityInput').value;
    const box = document.getElementById('suggestionBox');
    
    clearTimeout(debounceTimer);
    if (query.length < 2) { box.classList.add('hidden'); return; }

    debounceTimer = setTimeout(async () => {
        try {
            // åŠ å…¥ User-Agent æ˜¯å› ç‚º Nominatim æœ‰æ™‚æœƒæ“‹æ‰æ²’è­˜åˆ¥èº«ä»½çš„è«‹æ±‚
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`, {
                headers: { 'User-Agent': 'MyTravelApp/1.0' }
            });
            const data = await res.json();
            
            if (data.length === 0) {
                box.innerHTML = `<div class="p-3 text-sm text-gray-500">æ‰¾ä¸åˆ°é€™å€‹åœ°æ–¹ï¼Œè«‹è©¦è©¦å…¶ä»–åç¨±</div>`;
            } else {
                box.innerHTML = data.map(item => `
                    <div class="suggestion-item p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-100 text-sm text-slate-700"
                         onclick="selectLocation('${item.display_name.replace(/'/g, "\\'")}', ${item.lat}, ${item.lon})">
                        ğŸ“ ${item.display_name}
                    </div>
                `).join('');
            }
            box.classList.remove('hidden');
        } catch (e) {
            console.error("æœå°‹æœå‹™ç•°å¸¸:", e);
            box.innerHTML = `<div class="p-3 text-sm text-red-500">æœå°‹æœå‹™æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>`;
            box.classList.remove('hidden');
        }
    }, 500);
}

function selectLocation(name, lat, lon) {
    // å–å¾—ç¬¬ä¸€å€‹é€—è™Ÿå‰çš„åç¨±ï¼ˆè¼ƒç°¡çŸ­ï¼‰
    const shortName = name.split(',')[0];
    document.getElementById('cityInput').value = shortName;
    document.getElementById('suggestionBox').classList.add('hidden');
    selectedLocation = { name: shortName, lat, lon };
    console.log("å·²é¸æ“‡åœ°é»:", selectedLocation);
}

// 2. ç²å–å¤©æ°£è³‡æ–™ (åŠ å…¥è©³ç´°ä»£ç¢¼æª¢æŸ¥)
async function fetchWeather(lat, lon) {
    if (!WEATHER_API_KEY || WEATHER_API_KEY.includes('åœ¨æ­¤è™•')) {
        return "âš ï¸ æœªè¨­å®š API Key";
    }
    try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=zh_tw`);
        const data = await res.json();
        
        if (data.cod === 401) return "âŒ API Key å°šæœªç”Ÿæ•ˆ (éœ€ç­‰2å°æ™‚)";
        if (data.cod !== 200) return "âŒ å¤©æ°£è®€å–éŒ¯èª¤";
        
        return `${Math.round(data.main.temp)}Â°C ${data.weather[0].description}`;
    } catch {
        return "ğŸŒ ç¶²è·¯é€£ç·šå¤±æ•—";
    }
}
// ... å¾ŒçºŒçš„ addTrip, render ç­‰åŠŸèƒ½ä¿æŒä¸è®Š
